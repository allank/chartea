package main

import (
	"log"
	"os"

	"github.com/allank/chartea/clob"

	tea "github.com/charmbracelet/bubbletea"
	"github.com/charmbracelet/lipgloss"
)

// mainModel represents the state of our TUI application.
type mainModel struct {
	clob   clob.Model
	width  int
	height int
}

// InitialModel creates the initial state of the application model.
func InitialModel() mainModel {
	m := mainModel{
		clob: clob.New(),
	}
	m.clob.Asks = []clob.Order{
		{Price: 2125757.000000000000000000, Volume: 0.072099000000000000},
		{Price: 2126000.000000000000000000, Volume: 0.002988000000000000},
		{Price: 2126658.000000000000000000, Volume: 0.003000000000000000},
		{Price: 2126659.000000000000000000, Volume: 0.031956000000000000},
		{Price: 2126723.000000000000000000, Volume: 0.002323000000000000},
		{Price: 2126799.000000000000000000, Volume: 0.002309000000000000},
		{Price: 2127487.000000000000000000, Volume: 0.002238000000000000},
		{Price: 2127786.000000000000000000, Volume: 0.002241000000000000},
		{Price: 2127862.000000000000000000, Volume: 0.002254000000000000},
		{Price: 2128124.000000000000000000, Volume: 0.002224000000000000},
		{Price: 2128209.000000000000000000, Volume: 0.002231000000000000},
		{Price: 2128535.000000000000000000, Volume: 0.002252000000000000},
		{Price: 2128552.000000000000000000, Volume: 0.002250000000000000},
		{Price: 2128563.000000000000000000, Volume: 0.023851000000000000},
		{Price: 2129570.000000000000000000, Volume: 0.002267000000000000},
		{Price: 2129588.000000000000000000, Volume: 0.249000000000000000},
		{Price: 2129589.000000000000000000, Volume: 0.023359000000000000},
		{Price: 2129598.000000000000000000, Volume: 0.002233000000000000},
		{Price: 2129620.000000000000000000, Volume: 0.346500000000000000},
		{Price: 2129622.000000000000000000, Volume: 0.126600000000000000},
		{Price: 2129831.000000000000000000, Volume: 0.001707000000000000},
		{Price: 2130000.000000000000000000, Volume: 0.018152000000000000},
		{Price: 2130148.000000000000000000, Volume: 0.002265000000000000},
		{Price: 2130624.000000000000000000, Volume: 0.003147000000000000},
		{Price: 2130633.000000000000000000, Volume: 0.002234000000000000},
		{Price: 2130866.000000000000000000, Volume: 0.002776000000000000},
		{Price: 2130894.000000000000000000, Volume: 0.001713000000000000},
		{Price: 2131211.000000000000000000, Volume: 0.002267000000000000},
		{Price: 2131513.000000000000000000, Volume: 0.433200000000000000},
		{Price: 2131717.000000000000000000, Volume: 0.017666000000000000},
		{Price: 2131797.000000000000000000, Volume: 0.002184000000000000},
		{Price: 2132861.000000000000000000, Volume: 0.002263000000000000},
		{Price: 2133017.000000000000000000, Volume: 0.176300000000000000},
		{Price: 2133276.000000000000000000, Volume: 0.126600000000000000},
		{Price: 2133493.000000000000000000, Volume: 0.157695000000000000},
		{Price: 2134666.000000000000000000, Volume: 0.004684000000000000},
		{Price: 2134840.000000000000000000, Volume: 0.007826000000000000},
		{Price: 2135056.000000000000000000, Volume: 0.002000000000000000},
		{Price: 2135675.000000000000000000, Volume: 0.001863000000000000},
		{Price: 2138726.000000000000000000, Volume: 0.126600000000000000},
		{Price: 2139007.000000000000000000, Volume: 0.050000000000000000},
		{Price: 2140000.000000000000000000, Volume: 2.284700000000000000},
		{Price: 2142999.000000000000000000, Volume: 0.000100000000000000},
		{Price: 2143333.000000000000000000, Volume: 0.028000000000000000},
		{Price: 2143392.000000000000000000, Volume: 0.034350000000000000},
		{Price: 2144000.000000000000000000, Volume: 0.002832000000000000},
		{Price: 2144021.000000000000000000, Volume: 0.001270000000000000},
		{Price: 2144744.000000000000000000, Volume: 0.000784000000000000},
		{Price: 2145000.000000000000000000, Volume: 0.005977000000000000},
		{Price: 2146402.000000000000000000, Volume: 0.000154000000000000},
		{Price: 2147000.000000000000000000, Volume: 0.222860000000000000},
		{Price: 2147500.000000000000000000, Volume: 0.000326000000000000},
		{Price: 2149000.000000000000000000, Volume: 0.006334000000000000},
		{Price: 2149100.000000000000000000, Volume: 0.024287000000000000},
		{Price: 2149663.000000000000000000, Volume: 0.001904000000000000},
		{Price: 2150000.000000000000000000, Volume: 1.453821000000000000},
		{Price: 2150051.000000000000000000, Volume: 0.000320000000000000},
		{Price: 2150298.000000000000000000, Volume: 0.001000000000000000},
		{Price: 2150503.000000000000000000, Volume: 0.000100000000000000},
		{Price: 2151003.000000000000000000, Volume: 0.003730000000000000},
		{Price: 2151634.000000000000000000, Volume: 0.000869000000000000},
		{Price: 2153587.000000000000000000, Volume: 0.002321000000000000},
		{Price: 2154163.000000000000000000, Volume: 0.034350000000000000},
		{Price: 2154545.000000000000000000, Volume: 0.001930000000000000},
		{Price: 2155000.000000000000000000, Volume: 0.006373000000000000},
		{Price: 2155780.000000000000000000, Volume: 0.139161000000000000},
		{Price: 2156676.000000000000000000, Volume: 0.000463000000000000},
		{Price: 2157891.000000000000000000, Volume: 0.050000000000000000},
		{Price: 2159000.000000000000000000, Volume: 0.000463000000000000},
		{Price: 2160000.000000000000000000, Volume: 2.356520000000000000},
		{Price: 2163000.000000000000000000, Volume: 0.000300000000000000},
		{Price: 2165000.000000000000000000, Volume: 0.001712000000000000},
		{Price: 2165086.000000000000000000, Volume: 0.034350000000000000},
		{Price: 2167000.000000000000000000, Volume: 0.030153000000000000},
		{Price: 2170000.000000000000000000, Volume: 0.018553000000000000},
		{Price: 2170071.000000000000000000, Volume: 0.000520000000000000},
		{Price: 2170300.000000000000000000, Volume: 0.000922000000000000},
		{Price: 2170547.000000000000000000, Volume: 0.000138000000000000},
		{Price: 2170786.000000000000000000, Volume: 0.050000000000000000},
		{Price: 2174999.000000000000000000, Volume: 0.000500000000000000},
		{Price: 2175912.000000000000000000, Volume: 0.034350000000000000},
		{Price: 2178230.000000000000000000, Volume: 0.006000000000000000},
		{Price: 2179999.000000000000000000, Volume: 0.000500000000000000},
		{Price: 2180000.000000000000000000, Volume: 0.815604000000000000},
		{Price: 2180013.000000000000000000, Volume: 0.024986000000000000},
		{Price: 2180500.000000000000000000, Volume: 0.001329000000000000},
		{Price: 2180786.000000000000000000, Volume: 0.050000000000000000},
		{Price: 2181081.000000000000000000, Volume: 0.001252000000000000},
		{Price: 2181111.000000000000000000, Volume: 0.045848000000000000},
		{Price: 2184221.000000000000000000, Volume: 0.000500000000000000},
		{Price: 2184999.000000000000000000, Volume: 0.000500000000000000},
		{Price: 2185000.000000000000000000, Volume: 0.072082000000000000},
		{Price: 2185550.000000000000000000, Volume: 0.003000000000000000},
		{Price: 2185622.000000000000000000, Volume: 0.020000000000000000},
		{Price: 2186500.000000000000000000, Volume: 0.022867000000000000},
		{Price: 2186791.000000000000000000, Volume: 0.034350000000000000},
		{Price: 2189000.000000000000000000, Volume: 0.004270000000000000},
		{Price: 2189350.000000000000000000, Volume: 0.026949000000000000},
		{Price: 2189999.000000000000000000, Volume: 0.000500000000000000},
		{Price: 2190000.000000000000000000, Volume: 2.434311000000000000},
	}
	m.clob.Bids = []clob.Order{
		{Price: 2125756.000000000000000000, Volume: 0.301583000000000000},
		{Price: 2125084.000000000000000000, Volume: 0.083000000000000000},
		{Price: 2125083.000000000000000000, Volume: 0.040019000000000000},
		{Price: 2125036.000000000000000000, Volume: 0.198300000000000000},
		{Price: 2124935.000000000000000000, Volume: 0.002241000000000000},
		{Price: 2124907.000000000000000000, Volume: 0.036400000000000000},
		{Price: 2124170.000000000000000000, Volume: 0.002217000000000000},
		{Price: 2123460.000000000000000000, Volume: 0.065031000000000000},
		{Price: 2123214.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2122914.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2122614.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2122610.000000000000000000, Volume: 0.040972000000000000},
		{Price: 2122314.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2122014.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2121907.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2121650.000000000000000000, Volume: 0.126600000000000000},
		{Price: 2121307.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2120707.000000000000000000, Volume: 0.000470000000000000},
		{Price: 2120183.000000000000000000, Volume: 0.147400000000000000},
		{Price: 2120000.000000000000000000, Volume: 0.000972000000000000},
		{Price: 2119857.000000000000000000, Volume: 0.002117000000000000},
		{Price: 2119831.000000000000000000, Volume: 0.050000000000000000},
		{Price: 2119788.000000000000000000, Volume: 0.019613000000000000},
		{Price: 2119686.000000000000000000, Volume: 0.002353000000000000},
		{Price: 2119580.000000000000000000, Volume: 0.002353000000000000},
		{Price: 2119438.000000000000000000, Volume: 0.126600000000000000},
		{Price: 2119133.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2118533.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2117933.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2117333.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2116733.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2116133.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2116127.000000000000000000, Volume: 0.126600000000000000},
		{Price: 2116030.000000000000000000, Volume: 0.007000000000000000},
		{Price: 2115646.000000000000000000, Volume: 0.007000000000000000},
		{Price: 2115533.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2114933.000000000000000000, Volume: 0.000471000000000000},
		{Price: 2114761.000000000000000000, Volume: 0.005958000000000000},
		{Price: 2114588.000000000000000000, Volume: 0.006572000000000000},
		{Price: 2106054.000000000000000000, Volume: 0.000100000000000000},
		{Price: 2103000.000000000000000000, Volume: 0.000951000000000000},
		{Price: 2102887.000000000000000000, Volume: 0.235100000000000000},
		{Price: 2102886.000000000000000000, Volume: 0.125000000000000000},
		{Price: 2100228.000000000000000000, Volume: 0.000238000000000000},
		{Price: 2100001.000000000000000000, Volume: 0.001190000000000000},
		{Price: 2100000.000000000000000000, Volume: 0.295476000000000000},
		{Price: 2099000.000000000000000000, Volume: 0.001628000000000000},
		{Price: 2096252.000000000000000000, Volume: 0.238521000000000000},
		{Price: 2095000.000000000000000000, Volume: 0.002174000000000000},
		{Price: 2086665.000000000000000000, Volume: 0.251145000000000000},
		{Price: 2080777.000000000000000000, Volume: 0.048058000000000000},
		{Price: 2080650.000000000000000000, Volume: 0.000522000000000000},
		{Price: 2072866.000000000000000000, Volume: 0.231563000000000000},
		{Price: 2070500.000000000000000000, Volume: 0.000935000000000000},
		{Price: 2070000.000000000000000000, Volume: 0.010000000000000000},
		{Price: 2067983.000000000000000000, Volume: 0.014245000000000000},
		{Price: 2062886.000000000000000000, Volume: 0.125000000000000000},
		{Price: 2050051.000000000000000000, Volume: 0.001219000000000000},
		{Price: 2050000.000000000000000000, Volume: 0.019833000000000000},
		{Price: 2045800.000000000000000000, Volume: 0.003299000000000000},
		{Price: 2045540.000000000000000000, Volume: 0.010999000000000000},
		{Price: 2040000.000000000000000000, Volume: 0.009559000000000000},
		{Price: 2035000.000000000000000000, Volume: 0.010000000000000000},
		{Price: 2033701.000000000000000000, Volume: 0.003255000000000000},
		{Price: 2030100.000000000000000000, Volume: 0.186070000000000000},
		{Price: 2030000.000000000000000000, Volume: 0.219568000000000000},
		{Price: 2029999.000000000000000000, Volume: 0.009852000000000000},
		{Price: 2026886.000000000000000000, Volume: 0.125000000000000000},
		{Price: 2024516.000000000000000000, Volume: 0.035305000000000000},
		{Price: 2024200.000000000000000000, Volume: 0.000376000000000000},
		{Price: 2023120.000000000000000000, Volume: 0.188481000000000000},
		{Price: 2020001.000000000000000000, Volume: 0.069074000000000000},
		{Price: 2020000.000000000000000000, Volume: 0.113406000000000000},
		{Price: 2019999.000000000000000000, Volume: 0.009900000000000000},
		{Price: 2017710.000000000000000000, Volume: 0.017347000000000000},
		{Price: 2016065.000000000000000000, Volume: 0.001133000000000000},
		{Price: 2015187.000000000000000000, Volume: 0.002120000000000000},
		{Price: 2013650.000000000000000000, Volume: 0.000200000000000000},
		{Price: 2013296.000000000000000000, Volume: 0.016066000000000000},
		{Price: 2013000.000000000000000000, Volume: 0.000496000000000000},
		{Price: 2010701.000000000000000000, Volume: 0.000186000000000000},
		{Price: 2010265.000000000000000000, Volume: 0.002011000000000000},
		{Price: 2010000.000000000000000000, Volume: 0.012493000000000000},
		{Price: 2004115.000000000000000000, Volume: 0.000100000000000000},
		{Price: 2002021.000000000000000000, Volume: 0.203681000000000000},
		{Price: 2000616.000000000000000000, Volume: 0.002500000000000000},
		{Price: 2000221.000000000000000000, Volume: 0.009998000000000000},
		{Price: 2000100.000000000000000000, Volume: 0.010500000000000000},
		{Price: 2000001.000000000000000000, Volume: 0.001061000000000000},
		{Price: 2000000.000000000000000000, Volume: 0.561236000000000000},
		{Price: 1998200.000000000000000000, Volume: 0.000200000000000000},
		{Price: 1998000.000000000000000000, Volume: 0.007502000000000000},
		{Price: 1997000.000000000000000000, Volume: 0.055075000000000000},
		{Price: 1996332.000000000000000000, Volume: 0.012522000000000000},
		{Price: 1995000.000000000000000000, Volume: 0.002230000000000000},
		{Price: 1990000.000000000000000000, Volume: 0.100393000000000000},
		{Price: 1988109.000000000000000000, Volume: 0.029320000000000000},
		{Price: 1987950.000000000000000000, Volume: 0.029322000000000000},
		{Price: 1987802.000000000000000000, Volume: 0.032214000000000000},
		{Price: 1987322.000000000000000000, Volume: 0.037710000000000000},
	}
	// Set VolumePrecision
	m.clob.VolumePrecision = 8
	// Override default styles
	m.clob.StyleOnBid = lipgloss.NewStyle().
		Foreground(lipgloss.Color("228")).
		Background(lipgloss.Color("28"))
	m.clob.StyleOnAsk = lipgloss.NewStyle().
		Foreground(lipgloss.Color("228")).
		Background(lipgloss.Color("197"))

	return m
}

// Init is the first command that is run when the program starts.
func (m mainModel) Init() tea.Cmd {
	return nil
}

// Update handles all incoming messages and updates the model accordingly.
func (m mainModel) Update(msg tea.Msg) (tea.Model, tea.Cmd) {
	switch msg := msg.(type) {
	case tea.WindowSizeMsg:
		m.width = msg.Width
		m.height = msg.Height
	case tea.KeyMsg:
		switch msg.String() {
		case "ctrl+c", "q":
			return m, tea.Quit
		}
	}

	var cmd tea.Cmd
	m.clob, cmd = m.clob.Update(msg)
	return m, cmd
}

// View renders the UI based on the current model state.
func (m mainModel) View() string {
	return m.clob.ViewWithOptions(clob.ViewOptions{Width: m.width, Height: m.height})
}

func main() {
	p := tea.NewProgram(InitialModel(), tea.WithAltScreen())

	if _, err := p.Run(); err != nil {
		log.Fatalf("Alas, there's been an error: %v", err)
		os.Exit(1)
	}
}
